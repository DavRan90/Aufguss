@page "/Info"
@attribute [Authorize(Roles = "Admin,SuperAdmin")]
@using Aufguss.Models
@using System.Text.Json.Nodes
@using System.Text.Json
@implements IAsyncDisposable

<div class="card mb-5">
    <h2>Lägg till text</h2>
    <QuillEditor @ref="editor"/>
<button class="btn btn-primary my-2" @onclick="Save">Spara</button>
</div>

<div class="card mb-5">
    <h4>Preview</h4>
<div class="border p-3 rounded">
    @((MarkupString)EditorHtml)
</div>
</div>


<div class="card mb-5">
    <h1 class="mb-5">Lägg till Frågor och Svar</h1>
    <EditForm Model="FaqDtoData" OnValidSubmit="SaveFaq">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="row mb-3">
            <label class="col-md-2 col-form-label">Fråga</label>
            <div class="col-md-4">
                <InputText class="form-control" @bind-Value="FaqDtoData.Question" />
                <ValidationMessage For="@(() => FaqDtoData.Question)" />
            </div>
        </div>

        <div class="row mb-3">
            <label class="col-md-2 col-form-label">Svar</label>
            <div class="col-md-4">
                <InputTextArea rows="4" class="form-control" @bind-Value="FaqDtoData.Answer" />
                <ValidationMessage For="@(() => FaqDtoData.Answer)" />
            </div>
        </div>

        <div class="row">
            <div class="offset-md-2 col-md-2 d-grid">
                <button type="submit" class="btn btn-primary">Spara</button>
            </div>
            <div class="col-md-2 d-grid">
                <a class="btn btn-outline-primary" href="/Info">Avbryt</a>
            </div>
        </div>
    </EditForm>
</div>

@if (faqs == null)
{
        <p><em>Laddar...</em></p>
}
else
{
        <div class="card">
            <h3 class="m-3">Frågor och svar</h3>
            <div id="faqAccordion" class="accordion">
            @foreach (var faq in faqs)
            {
                        <div class="d-flex flex-md-row align-items-stretch mb-3 w-100">
                            <div class="accordion-item flex-grow-1 rounded h-100" data-id="@faq.Id">
                                <div class="accordion-header d-flex align-items-center" style="user-select:none;">
                                    <div class="drag-handle me-2 bg-info-subtle rounded p-3"
                                         style="cursor: grab; padding: 0 8px;"
                            @onclick:stopPropagation
                            @onmousedown:stopPropagation>
                                        ☰
                                    </div>
                                    <button class="accordion-button collapsed flex-grow-1"
                                            type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#collapse-@faq.Id"
                                            aria-expanded="false"
                                            aria-controls="collapse-@faq.Id">
                                @faq.Question
                                    </button>
                                </div>

                                <div id="collapse-@faq.Id"
                                     class="accordion-collapse collapse"
                                     aria-labelledby="heading-@faq.Id"
                                     data-bs-parent="#faqAccordion">
                                    <div class="accordion-body">
                                @faq.Answer
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex flex-column">
                                <button class="btn btn-sm btn-outline-warning mb-1 mb-md-0 me-md-1 ms-1"
                                        title="Ändra"
                                        @onclick="async () => await EditAlert(faq.Id)">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger mb-1 mb-md-0 me-md-1 ms-1"
                                        title="Ta bort"
                                        @onclick="async () => await ShowRemoveAlert(faq.Id)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
            }
            </div>
        </div>
}

@code {
    private QuillEditor? editor;
    private string EditorHtml = "";
    private List<Faq>? faqs;
    public FaqDto FaqDtoData { get; set; } = new();
    public JsonNode Errors { get; set; } = new JsonObject();
    private bool sortableInitialized = false;

    [Inject] private IJSRuntime JS { get; set; } = default!;
    [Inject] private IFaqService FaqService { get; set; } = default!;
    [Inject] private SweetAlertService Swal { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        faqs = await FaqService.GetFaqsAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && faqs != null && !sortableInitialized)
        {
            sortableInitialized = true;
            var objRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("initializeSortable", "faqAccordion", objRef);
        }
    }

    private async Task Save()
    {
        if (editor is null)
            return;

        EditorHtml = await editor.GetHtml();
    }

    private async Task SaveFaq()
    {
        var createdFaq = await FaqService.AddFaqAsync(FaqDtoData);
        faqs.Add(createdFaq);
        FaqDtoData = new FaqDto(); // Reset form
        StateHasChanged();
    }

    [JSInvokable]
    public async Task UpdateOrder(string[] newOrder)
    {
        for (int i = 0; i < newOrder.Length; i++)
        {
            var id = int.Parse(newOrder[i]);
            var faq = faqs.First(f => f.Id == id);
            faq.Position = i;
        }
        await FaqService.UpdateFaqOrderAsync(faqs);
    }

    private async Task DeleteFaq(int id)
    {
        await FaqService.RemoveFaqAsync(id);
        faqs = await FaqService.GetFaqsAsync();
        StateHasChanged();
    }

    private async Task EditAlert(int id)
    {
        var getFaq = await FaqService.GetFaqAsync(id);
        string json = await JS.InvokeAsync<string>("showFaqAlert", getFaq);

        if (!string.IsNullOrEmpty(json))
        {
            var faq = JsonSerializer.Deserialize<FaqDto>(json, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                });

            if (faq != null)
            {
                await FaqService.EditFaqAsync(id, faq);
                faqs = await FaqService.GetFaqsAsync();
                StateHasChanged();
                await JS.InvokeVoidAsync("Swal.fire", "Lyckades", "FAQ ändrad!", "success");
            }
        }
    }

    private async Task ShowRemoveAlert(int id)
    {
        var result = await Swal.FireAsync(new SweetAlertOptions
            {
                Title = "Bekräfta borttagning",
                Text = $"Vill du ta bort FAQ med ID {id}?",
                ShowCancelButton = true,
                ConfirmButtonText = "Ja, ta bort",
                CancelButtonText = "Nej, ta inte bort",
            });

        if (result.IsConfirmed)
        {
            await DeleteFaq(id);
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (editor != null)
        {
            await editor.DisposeAsync(); // Cleanly destroy Quill
        }
    }
}
